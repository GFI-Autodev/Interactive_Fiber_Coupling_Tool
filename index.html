<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Coupling Simulator | DiCon Fiberoptics</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Chart Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 400px;
        }
        /* Canvas Styles */
        .viz-canvas {
            background: #0f172a; /* Slate 900 */
            box-shadow: inset 0 0 20px #000;
            display: block;
            margin: 0 auto;
        }
        #beamCanvasTop { border-radius: 50%; }
        #beamCanvasSide { border-radius: 8px; }
        
        /* Custom Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        input[type=range]:focus { outline: none; }

        /* Custom Number Input Styling */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-blue-200 selection:text-blue-900 font-sans">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <!-- DiCon Branding Area -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-900 rounded-lg flex items-center justify-center text-white font-serif font-bold text-xl shadow-sm">
                    D
                </div>
                <div class="flex flex-col">
                    <div class="leading-none">
                        <span class="text-2xl font-black text-blue-900 tracking-tighter">DiCon</span>
                        <span class="text-2xl font-light text-slate-600 tracking-tight">Fiberoptics</span>
                    </div>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wide uppercase mt-1">Directing Light with MEMS Technology</p>
                </div>
            </div>
            
            <div class="mt-4 md:mt-0 text-right flex items-center gap-3">
                <span class="hidden md:inline text-xs text-slate-400">Advanced Simulation Tool v3.0</span>
                <span id="systemStatus" class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                    System Ready
                </span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <!-- Intro -->
        <section class="mb-8 max-w-5xl mx-auto text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-800">Fiber-to-Fiber Coupling & Alignment Physics</h2>
            <p class="text-slate-600 text-sm md:text-base max-w-3xl mx-auto leading-relaxed">
                Visualize the impact of 5-axis misalignment (X, Y, Z, Tilt X, Tilt Y) on coupling efficiency.
                Configure fiber parameters below to simulate different setups, demonstrating <strong class="text-blue-900">DiCon's expertise in high-precision free-space optics</strong>.
            </p>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: Controls & Parameters -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Result Display -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-100 ring-1 ring-slate-900/5">
                    <div class="bg-blue-900 px-6 py-4 flex justify-between items-center">
                        <h3 class="text-white font-semibold text-sm tracking-wide">REAL-TIME METRICS</h3>
                        <span id="lambdaDisplay" class="text-blue-200 text-xs font-mono">λ = 1550 nm</span>
                    </div>
                    <div class="p-6 text-center">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Coupling Efficiency</span>
                                <span id="effDisplay" class="text-3xl font-bold text-blue-700 font-mono">--%</span>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Insertion Loss (IL)</span>
                                <span id="lossDisplay" class="text-3xl font-bold text-red-600 font-mono">-- dB</span>
                            </div>
                        </div>
                        <!-- Progress Bar -->
                        <div class="relative w-full bg-slate-200 rounded-full h-3 overflow-hidden shadow-inner">
                            <div id="efficiencyBar" class="absolute top-0 left-0 h-full bg-blue-600 transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                        <div id="feedbackText" class="mt-4 p-2 rounded bg-slate-50 text-xs text-slate-500 min-h-[3em] flex items-center justify-center font-medium">
                            Initializing...
                        </div>
                    </div>
                </div>

                <!-- NEW: Fiber Parameters Configuration -->
                <div class="bg-slate-100 rounded-xl p-5 border border-slate-200 shadow-inner">
                    <h3 class="text-sm font-bold text-blue-900 mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Fiber Parameters Configuration
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">Fiber Type Preset</label>
                            <select id="fiberPreset" class="w-full text-sm bg-white border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="smf28">Corning SMF-28 (Standard Telecom)</option>
                                <option value="hi1060">Corning HI 1060 (Short Wavelength)</option>
                                <option value="custom">Custom Specification</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">Wavelength (nm)</label>
                                <input type="number" id="lambdaInput" min="400" max="2000" step="1" class="w-full text-sm bg-white border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">MFD (μm)</label>
                                <input type="number" id="mfdInput" min="1" max="20" step="0.1" class="w-full text-sm bg-white border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono">
                            </div>
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-slate-500 mb-1">Approx. Numerical Aperture (NA)</label>
                             <div id="naDisplay" class="w-full text-sm bg-slate-200 border border-slate-300 rounded-md px-3 py-2 font-mono text-slate-600">
                                 --
                             </div>
                             <p class="text-[10px] text-slate-400 mt-1">*NA is derived from MFD and Wavelength using Gaussian approximation (2λ / π·MFD).</p>
                        </div>
                    </div>
                </div>

                <!-- Alignment Controls -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            Alignment Controls
                        </h3>
                        <button id="resetBtn" class="text-xs text-blue-600 hover:text-white hover:bg-blue-600 font-medium px-3 py-1 bg-blue-50 rounded-full transition-all duration-200">
                            Reset Alignment
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Z Axis -->
                        <div class="relative group">
                            <div class="flex justify-between mb-2">
                                <label for="zInput" class="text-sm font-bold text-slate-700 flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-slate-400 mr-2 group-hover:bg-blue-500 transition-colors"></span>Z: Axial Gap
                                </label>
                                <span id="zVal" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">0 μm</span>
                            </div>
                            <input type="range" id="zInput" min="0" max="250" step="1" value="0" 
                                class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-slate-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:bg-blue-600 hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                        </div>

                        <div class="grid grid-cols-2 gap-x-4 gap-y-6">
                            <!-- X Axis -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="xInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>Offset X
                                    </label>
                                    <span id="xVal" class="text-[10px] font-mono bg-red-50 px-1.5 py-0.5 rounded text-red-600 border border-red-100">0.0</span>
                                </div>
                                <input type="range" id="xInput" min="-15" max="15" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-red-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Y Axis -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="yInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>Offset Y
                                    </label>
                                    <span id="yVal" class="text-[10px] font-mono bg-red-50 px-1.5 py-0.5 rounded text-red-600 border border-red-100">0.0</span>
                                </div>
                                <input type="range" id="yInput" min="-15" max="15" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-red-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Tilt X -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="txInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-1.5"></span>Tilt X
                                    </label>
                                    <span id="txVal" class="text-[10px] font-mono bg-purple-50 px-1.5 py-0.5 rounded text-purple-600 border border-purple-100">0.0°</span>
                                </div>
                                <input type="range" id="txInput" min="-3" max="3" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Tilt Y -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="tyInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-1.5"></span>Tilt Y
                                    </label>
                                    <span id="tyVal" class="text-[10px] font-mono bg-purple-50 px-1.5 py-0.5 rounded text-purple-600 border border-purple-100">0.0°</span>
                                </div>
                                <input type="range" id="tyInput" min="-3" max="3" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Visualizations -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Visualization 1: Dual Beam Views (Top & Side) -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">1</span>
                            Fiber Alignment Visualization (Top & Side Views)
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Top View -->
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-500 mb-2">Top View (Beam Overlap)</span>
                            <div class="bg-slate-50 rounded-lg py-4 border border-slate-100 shadow-inner w-full flex justify-center">
                                <canvas id="beamCanvasTop" width="280" height="280" class="viz-canvas"></canvas>
                            </div>
                        </div>
                        <!-- Side View -->
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-500 mb-2">Side View (Z-Gap & Tilt)</span>
                            <div class="bg-slate-50 rounded-lg py-4 border border-slate-100 shadow-inner w-full flex justify-center items-center" style="height: 312px;">
                                <canvas id="beamCanvasSide" width="320" height="200" class="viz-canvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-center gap-6 text-xs text-slate-500">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500 ring-2 ring-blue-200"></span> Fixed Fiber (Left)
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500 ring-2 ring-red-200"></span> Moving Fiber (Right)
                        </div>
                    </div>
                </div>

                <!-- Visualization 2: Sensitivity -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">2</span>
                            Alignment Sensitivity Profile (X-Axis)
                        </h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Efficiency drop-off curve for lateral misalignment at current Z/Tilt and Fiber Specs.</p>
                    <div class="chart-container">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                </div>

                <!-- Visualization 3: Heatmap -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">3</span>
                            2D Coupling Landscape (Heatmap)
                        </h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Brighter regions indicate "Sweet Spot" for optimal coupling.</p>
                    <!-- Plotly uses its own container -->
                    <div id="contourPlot" class="w-full h-[350px] border border-slate-100 rounded-lg overflow-hidden shadow-inner"></div>
                </div>

            </div>
        </div>
    </main>

    <footer class="mt-12 py-10 bg-blue-950 text-slate-400 text-center border-t border-blue-900">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center mb-4">
                <span class="text-xl font-black text-white tracking-tighter mb-1">DiCon Fiberoptics</span>
                <p class="text-xs text-blue-300">Innovating Optical Solutions</p>
            </div>
            <p class="text-xs mb-2">© 2025 DiCon Fiberoptics, Inc. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        window.addEventListener('load', function() {
            console.log("DiCon Advanced System Initializing...");
            
            // --- 1. DOM Elements ---
            const els = {
                status: document.getElementById('systemStatus'),
                lambdaDisplay: document.getElementById('lambdaDisplay'),
                naDisplay: document.getElementById('naDisplay'),
                // Fiber Params
                fiberPreset: document.getElementById('fiberPreset'),
                lambdaInput: document.getElementById('lambdaInput'),
                mfdInput: document.getElementById('mfdInput'),
                // Alignment Inputs
                inputs: {
                    x: document.getElementById('xInput'),
                    y: document.getElementById('yInput'),
                    z: document.getElementById('zInput'),
                    tx: document.getElementById('txInput'),
                    ty: document.getElementById('tyInput')
                },
                // Value Displays
                vals: {
                    x: document.getElementById('xVal'),
                    y: document.getElementById('yVal'),
                    z: document.getElementById('zVal'),
                    tx: document.getElementById('txVal'),
                    ty: document.getElementById('tyVal')
                },
                // Results
                results: {
                    eff: document.getElementById('effDisplay'),
                    loss: document.getElementById('lossDisplay'),
                    bar: document.getElementById('efficiencyBar'),
                    feedback: document.getElementById('feedbackText')
                },
                btn: { reset: document.getElementById('resetBtn') },
                // Canvases
                canvasTop: document.getElementById('beamCanvasTop'),
                canvasSide: document.getElementById('beamCanvasSide')
            };

            // --- 2. State & Physics Constants ---
            // Alignment State
            const state = { x: 0, y: 0, z: 0, tx: 0, ty: 0 };
            
            // Fiber Parameter Presets dictionary
            const fiberData = {
                'smf28': { lambda: 1550, mfd: 10.4, name: "Corning SMF-28" },
                'hi1060': { lambda: 1060, mfd: 6.2, name: "Corning HI 1060" },
                // Add more presets here if needed
            };

            // Current Physics Parameters (Dynamic)
            let physics = {
                lambdaMicrons: 1.550,
                w0: 5.2,   // MFD/2
                k: 0,      // Wave number
                zR: 0,     // Rayleigh range
                naApprox: 0
            };

            // Function to update physics constants based on inputs
            function updatePhysicsParams() {
                // Read from inputs
                let lambdaNm = parseFloat(els.lambdaInput.value) || 1550;
                let mfdMicrons = parseFloat(els.mfdInput.value) || 10.4;

                // Constrain inputs to reasonable physical limits to prevent crashes
                lambdaNm = Math.max(400, Math.min(2500, lambdaNm));
                mfdMicrons = Math.max(1, Math.min(50, mfdMicrons));
                
                // Update Physics State
                physics.lambdaMicrons = lambdaNm / 1000;
                physics.w0 = mfdMicrons / 2;
                const n = 1.0; // Refractive index of gap (air)
                physics.k = (2 * Math.PI * n) / physics.lambdaMicrons;
                physics.zR = (Math.PI * physics.w0 * physics.w0) / physics.lambdaMicrons;

                // Calculate approximate NA for display: NA approx = 2 * lambda / (pi * MFD)
                physics.naApprox = (2 * physics.lambdaMicrons) / (Math.PI * mfdMicrons);

                // Update UI Displays for Params
                els.lambdaDisplay.textContent = `λ = ${lambdaNm} nm`;
                els.naDisplay.textContent = physics.naApprox.toFixed(3);
                
                console.log("Physics Updated:", physics);
            }

            // --- 3. Physics Engine (Using Dynamic Parameters) ---
            function calculateCoupling(dx, dy, dz, theta_x_deg, theta_y_deg) {
                const tx = theta_x_deg * (Math.PI / 180);
                const ty = theta_y_deg * (Math.PI / 180);

                // 1. Longitudinal Mismatch (using dynamic zR)
                const D = dz / physics.zR;
                const eta_z = 4 / (4 + (D * D));

                // 2. Lateral & Angular Misalignment (using dynamic w0, lambda)
                const r_sq = (dx*dx) + (dy*dy);
                const theta_sq = (tx*tx) + (ty*ty);
                
                const lat_term = r_sq / (physics.w0 * physics.w0);
                const ang_coeff = Math.pow((Math.PI * 1.0 * physics.w0) / physics.lambdaMicrons, 2);
                const ang_term = ang_coeff * theta_sq;

                const exponent = -eta_z * (lat_term + ang_term);
                const efficiency = eta_z * Math.exp(exponent);

                return Math.max(0, Math.min(1, efficiency));
            }

            function getLoss(eff) {
                if (eff <= 0.0001) return "> 40.0";
                return (-10 * Math.log10(eff)).toFixed(2);
            }

            // --- 4. Visualization Managers ---
            
            // A. Canvas Beam Visualizer (TOP VIEW)
            const ctxTop = els.canvasTop.getContext('2d');
            
            function drawTopView() {
                const w = els.canvasTop.width;
                const h = els.canvasTop.height;
                const cx = w / 2;
                const cy = h / 2;
                // Dynamic scale based on MFD so it fits nicely
                const scale = 100 / (physics.w0 * 4); 

                ctxTop.clearRect(0, 0, w, h);

                // Grid
                ctxTop.strokeStyle = 'rgba(255,255,255,0.05)';
                ctxTop.lineWidth = 1;
                ctxTop.beginPath(); ctxTop.moveTo(cx, 0); ctxTop.lineTo(cx, h); ctxTop.moveTo(0, cy); ctxTop.lineTo(w, cy); ctxTop.stroke();

                // 1. Fixed Fiber (Target) - Blue Ring
                ctxTop.beginPath();
                ctxTop.arc(cx, cy, physics.w0 * scale, 0, Math.PI * 2);
                ctxTop.strokeStyle = '#3b82f6'; ctxTop.lineWidth = 2; ctxTop.stroke();
                ctxTop.fillStyle = 'rgba(59, 130, 246, 0.1)'; ctxTop.fill();

                // 2. Moving Fiber (Source) - Red Blob
                const mx = cx + (state.x * scale);
                const my = cy - (state.y * scale); 
                // Beam Expansion at distance Z
                const wz = physics.w0 * Math.sqrt(1 + Math.pow(state.z/physics.zR, 2));
                const visualRadius = wz * scale;
                // Opacity fades with Z
                const intensity = Math.max(0.2, 1 / (1 + state.z/(physics.zR*0.5))); 

                ctxTop.beginPath();
                ctxTop.arc(mx, my, visualRadius, 0, Math.PI * 2);
                ctxTop.fillStyle = `rgba(239, 68, 68, ${intensity * 0.5})`; ctxTop.fill();
                ctxTop.strokeStyle = `rgba(239, 68, 68, ${intensity})`; ctxTop.lineWidth = 2; ctxTop.stroke();

                // Crosshairs & Tilt Arrow (as before)
                ctxTop.beginPath(); const ch = 4; ctxTop.moveTo(mx-ch, my); ctxTop.lineTo(mx+ch, my); ctxTop.moveTo(mx, my-ch); ctxTop.lineTo(mx, my+ch);
                ctxTop.strokeStyle = '#fff'; ctxTop.lineWidth = 1; ctxTop.stroke();
                const tiltMag = Math.sqrt(state.tx*state.tx + state.ty*state.ty);
                if (tiltMag > 0.2) {
                    const endX = mx + (state.ty * 10 * (1550/els.lambdaInput.value)); // Scale arrow length inverse to wavelength roughly
                    const endY = my - (state.tx * 10 * (1550/els.lambdaInput.value));
                    drawArrow(ctxTop, mx, my, endX, endY, '#d8b4fe');
                }
            }

            // Helper for arrows
            function drawArrow(ctx, fromX, fromY, toX, toY, color) {
                const headlen = 8; 
                const dx = toX - fromX;
                const dy = toY - fromY;
                const angle = Math.atan2(dy, dx);
                ctx.beginPath();
                ctx.moveTo(fromX, fromY); ctx.lineTo(toX, toY);
                ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.setLineDash([2, 2]); ctx.stroke(); ctx.setLineDash([]);
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
                ctx.fillStyle = color; ctx.fill();
            }

            // --- NEW: B. Canvas Side View Visualizer ---
            const ctxSide = els.canvasSide.getContext('2d');

            function drawSideView() {
                const w = els.canvasSide.width;
                const h = els.canvasSide.height;
                const centerY = h / 2;
                // Scale: pixels per micron. Needs to fit Z=250um horizontally.
                const scaleX = (w * 0.6) / 250; 
                const scaleY = scaleX * 3; // Exaggerate Y for visibility

                ctxSide.clearRect(0, 0, w, h);

                // Optical Axis Line
                ctxSide.strokeStyle = 'rgba(255,255,255,0.1)';
                ctxSide.setLineDash([5, 5]);
                ctxSide.beginPath(); ctxSide.moveTo(0, centerY); ctxSide.lineTo(w, centerY); ctxSide.stroke();
                ctxSide.setLineDash([]);

                const fiberWidth = 40; // visual width of fiber block
                const fiberHeight = 80; // visual height of fiber block
                const fixedFiberXEnd = w * 0.2; // end of fixed fiber
                
                // 1. Fixed Fiber (Left) - Blue
                ctxSide.fillStyle = '#1e3a8a'; // Dark blue body
                ctxSide.fillRect(fixedFiberXEnd - fiberWidth, centerY - fiberHeight/2, fiberWidth, fiberHeight);
                ctxSide.fillStyle = '#3b82f6'; // Core
                ctxSide.fillRect(fixedFiberXEnd - fiberWidth, centerY - (physics.w0*scaleY), fiberWidth, physics.w0*2*scaleY);
                // Face
                ctxSide.beginPath(); ctxSide.moveTo(fixedFiberXEnd, centerY - fiberHeight/2); ctxSide.lineTo(fixedFiberXEnd, centerY + fiberHeight/2); ctxSide.strokeStyle = '#60a5fa'; ctxSide.lineWidth=2; ctxSide.stroke();

                // 2. Moving Fiber (Right) - Red
                ctxSide.save(); // Save state for transformations

                // Calculate positions
                const zGapPx = state.z * scaleX;
                // Effective lateral offset magnitude = sqrt(x^2 + y^2)
                const lateralOffsetPx = Math.sqrt(state.x*state.x + state.y*state.y) * scaleY;
                // Direction of offset depends on X/Y mix, simplified for side view to just 'up'
                const movingFiberXStart = fixedFiberXEnd + zGapPx;
                const movingFiberYCenter = centerY - lateralOffsetPx; // Moves up for +offset

                // Apply Transformations: Translate then Rotate around the tip
                ctxSide.translate(movingFiberXStart, movingFiberYCenter);
                // Effective tilt magnitude = sqrt(tx^2 + ty^2)
                // Need to negate angle because canvas rotation is clockwise, tilt 'up' is negative angle
                const tiltRad = -Math.sqrt(state.tx*state.tx + state.ty*state.ty) * (Math.PI/180);
                // Exaggerate tilt for visualization
                ctxSide.rotate(tiltRad * 5); 

                // Draw Moving Fiber relative to origin (its tip)
                ctxSide.fillStyle = '#991b1b'; // Dark red body
                ctxSide.fillRect(0, -fiberHeight/2, fiberWidth, fiberHeight);
                ctxSide.fillStyle = '#ef4444'; // Core
                ctxSide.fillRect(0, -(physics.w0*scaleY), fiberWidth, physics.w0*2*scaleY);
                // Face
                ctxSide.beginPath(); ctxSide.moveTo(0, -fiberHeight/2); ctxSide.lineTo(0, fiberHeight/2); ctxSide.strokeStyle = '#fca5a5'; ctxSide.lineWidth=2; ctxSide.stroke();

                ctxSide.restore(); // Restore state

                // 3. Beam Divergence Cone (Simplified)
                // Draw from fixed fiber tip to moving fiber plane
                const beamEndX = movingFiberXStart;
                // Beam radius at distance Z
                const wzAtZ = physics.w0 * Math.sqrt(1 + Math.pow(state.z/physics.zR, 2));
                const beamRadiusPx = wzAtZ * scaleY;

                ctxSide.beginPath();
                ctxSide.moveTo(fixedFiberXEnd, centerY - (physics.w0*scaleY)); // Top of core fixed
                ctxSide.lineTo(beamEndX, centerY - beamRadiusPx); // Top of beam at Z
                ctxSide.lineTo(beamEndX, centerY + beamRadiusPx); // Bottom of beam at Z
                ctxSide.lineTo(fixedFiberXEnd, centerY + (physics.w0*scaleY)); // Bottom of core fixed
                ctxSide.closePath();
                
                // Gradient for beam
                const grd = ctxSide.createLinearGradient(fixedFiberXEnd, centerY, beamEndX, centerY);
                grd.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
                grd.addColorStop(1, 'rgba(59, 130, 246, 0.1)');
                ctxSide.fillStyle = grd;
                ctxSide.fill();
            }


            // C. Chart.js Sensitivity (Updated for dynamic physics)
            let sensChart = null;
            function initSensChart() {
                const ctxS = document.getElementById('sensitivityChart');
                if(!ctxS) return;
                // ... (Chart initialization logic remains similar to v2, omitted for brevity but included in final file)
                 sensChart = new Chart(ctxS, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Efficiency Profile',
                                data: [],
                                borderColor: '#1e3a8a', borderWidth: 2, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(30, 58, 138, 0.05)'
                            },
                            {
                                label: 'Current Position',
                                data: [],
                                borderColor: '#ef4444', backgroundColor: '#ef4444', pointRadius: 6, pointHoverRadius: 8, showLine: false
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                        plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', callbacks: { label: function(context) { return 'Eff: ' + (context.parsed.y * 100).toFixed(1) + '%'; } } } },
                        scales: { x: { type: 'linear', title: { display: true, text: 'X Offset (μm)', color: '#64748b' }, min: -15, max: 15, grid: { color: '#f1f5f9' }, ticks: { color: '#64748b' } }, y: { min: 0, max: 1.1, title: { display: true, text: 'Efficiency', color: '#64748b' }, ticks: { format: { style: 'percent' }, color: '#64748b' }, grid: { color: '#f1f5f9' } } }
                    }
                });
            }

            function updateSensChart() {
                if(!sensChart) return;
                const dataPoints = [];
                for(let i = -15; i <= 15; i+=0.5) {
                    // Uses current physics state
                    const eff = calculateCoupling(i, state.y, state.z, state.tx, state.ty);
                    dataPoints.push({x: i, y: eff});
                }
                const currEff = calculateCoupling(state.x, state.y, state.z, state.tx, state.ty);
                sensChart.data.datasets[0].data = dataPoints;
                sensChart.data.datasets[1].data = [{x: state.x, y: currEff}];
                sensChart.update('none');
            }

            // D. Plotly Heatmap (Updated for dynamic physics)
            let plotlyLoaded = false;
            function initPlotly() {
                 const container = document.getElementById('contourPlot');
                if(!container || typeof Plotly === 'undefined') return;
                const data = [{ z: [[0]], type: 'contour', colorscale: 'Viridis' }];
                const layout = { margin: { l: 40, r: 20, b: 40, t: 20 }, xaxis: { title: 'X (μm)', range: [-15, 15] }, yaxis: { title: 'Y (μm)', range: [-15, 15] }, autosize: true };
                Plotly.newPlot('contourPlot', data, layout, {displayModeBar: false, responsive: true}).then(() => { plotlyLoaded = true; updatePlotly(); });
            }

            function updatePlotly() {
                if(!plotlyLoaded) return;
                const size = 25; const limit = 15; const step = (limit*2) / (size-1);
                const xArr = []; const yArr = []; const zArr = [];
                for(let i=0; i<size; i++) {
                    const y = -limit + (i*step); yArr.push(y); const row = [];
                    for(let j=0; j<size; j++) {
                        const x = -limit + (j*step); if(i===0) xArr.push(x);
                        // Uses current physics state
                        row.push(calculateCoupling(x, y, state.z, state.tx, state.ty));
                    }
                    zArr.push(row);
                }
                const contourTrace = { type: 'contour', z: zArr, x: xArr, y: yArr, colorscale: [ [0, '#0f172a'], [0.2, '#1e3a8a'], [0.5, '#3b82f6'], [0.8, '#60a5fa'], [1, '#ffffff'] ], contours: { coloring: 'heatmap', showlabels: false }, showscale: false };
                const markerTrace = { type: 'scatter', mode: 'markers', x: [state.x], y: [state.y], marker: { color: 'red', size: 10, symbol: 'cross', line: {color:'white', width:1} } };
                const layout = { margin: { l: 40, r: 20, b: 40, t: 20 }, xaxis: { title: 'X (μm)', range: [-15, 15] }, yaxis: { title: 'Y (μm)', range: [-15, 15] }, autosize: true, showlegend: false };
                Plotly.react('contourPlot', [contourTrace, markerTrace], layout);
            }


            // --- 5. Master Update ---
            function updateUI() {
                // Update Numeric Displays
                els.vals.x.textContent = state.x.toFixed(1) + " μm";
                els.vals.y.textContent = state.y.toFixed(1) + " μm";
                els.vals.z.textContent = state.z.toFixed(0) + " μm";
                els.vals.tx.textContent = state.tx.toFixed(1) + "°";
                els.vals.ty.textContent = state.ty.toFixed(1) + "°";

                // Calculate main result using current physics params
                const eff = calculateCoupling(state.x, state.y, state.z, state.tx, state.ty);
                const db = getLoss(eff);
                const pct = (eff * 100).toFixed(1);

                els.results.eff.textContent = pct + "%";
                els.results.loss.textContent = db + " dB";
                els.results.bar.style.width = pct + "%";

                let barColor = "bg-red-500"; let statusText = ""; let statusClass = "text-red-600";
                if(eff > 0.9) { barColor = "bg-green-500"; statusText = "Excellent Alignment"; statusClass = "text-green-600 font-bold"; } 
                else if(eff > 0.5) { barColor = "bg-blue-500"; statusText = "Acceptable Signal"; statusClass = "text-blue-600 font-medium"; } 
                else if(eff > 0.1) { barColor = "bg-yellow-500"; statusText = "Weak Signal"; statusClass = "text-yellow-600"; } 
                else { statusText = "High Loss / Misaligned"; }

                els.results.bar.className = `absolute top-0 left-0 h-full transition-all duration-300 ease-out ${barColor}`;
                els.results.feedback.textContent = statusText;
                els.results.feedback.className = `mt-4 p-2 rounded bg-slate-50 text-xs text-center border border-slate-100 ${statusClass}`;

                // Update All Visualizations
                drawTopView();
                drawSideView(); // <-- NEW
                updateSensChart();
                updatePlotly();
            }

            // --- 6. Event Listeners ---
            function bindEvents() {
                // Alignment Inputs
                ['x', 'y', 'z', 'tx', 'ty'].forEach(key => {
                    els.inputs[key].addEventListener('input', (e) => {
                        state[key] = parseFloat(e.target.value);
                        updateUI();
                    });
                });

                // Reset Btn
                els.btn.reset.addEventListener('click', () => {
                    state.x = 0; state.y = 0; state.z = 0; state.tx = 0; state.ty = 0;
                    Object.keys(els.inputs).forEach(k => els.inputs[k].value = 0);
                    updateUI();
                });

                // Fiber Parameter Inputs
                els.fiberPreset.addEventListener('change', (e) => {
                    const preset = fiberData[e.target.value];
                    if (preset) {
                        els.lambdaInput.value = preset.lambda;
                        els.mfdInput.value = preset.mfd;
                        updatePhysicsParams();
                        updateUI();
                    }
                });

                // Manual Parameter Inputs (trigger recalc on change)
                ['lambdaInput', 'mfdInput'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        // Set preset dropwdown to 'custom' if manually changed
                        els.fiberPreset.value = 'custom';
                        updatePhysicsParams();
                        updateUI();
                    });
                });

                // Resize handling
                window.addEventListener('resize', () => {
                    if(sensChart) sensChart.resize();
                    if(plotlyLoaded) Plotly.Plots.resize('contourPlot');
                    drawTopView();
                    drawSideView();
                });
            }

            // --- 7. Ignite ---
            // Set initial fiber preset values
            els.fiberPreset.value = 'smf28';
            els.lambdaInput.value = fiberData['smf28'].lambda;
            els.mfdInput.value = fiberData['smf28'].mfd;

            updatePhysicsParams(); // Calculate initial physics constants
            initSensChart();
            initPlotly();
            bindEvents();
            updateUI();
            
            els.status.textContent = "System Ready";
        });
    </script>
</body>
</html>