<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fiber Coupling Simulator v6 | DiCon Fiberoptics</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Chart Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 400px;
        }
        /* Canvas Styles */
        .viz-canvas {
            background: #0f172a; /* Slate 900 */
            box-shadow: inset 0 0 20px #000;
            display: block;
            margin: 0 auto;
        }
        #beamCanvasTop { border-radius: 50%; }
        #beamCanvasSide { border-radius: 8px; }
        
        /* Custom Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        input[type=range]:focus { outline: none; }

        /* Custom Number Input Styling */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-blue-200 selection:text-blue-900 font-sans">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <!-- DiCon Branding Area -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-900 rounded-lg flex items-center justify-center text-white font-serif font-bold text-xl shadow-sm">
                    D
                </div>
                <div class="flex flex-col">
                    <div class="leading-none">
                        <span class="text-2xl font-black text-blue-900 tracking-tighter">DiCon</span>
                        <span class="text-2xl font-light text-slate-600 tracking-tight">Fiberoptics</span>
                    </div>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wide uppercase mt-1">Directing Light with MEMS Technology</p>
                </div>
            </div>
            
            <div class="mt-4 md:mt-0 text-right flex items-center gap-3">
                <!-- Language Toggle -->
                <button id="langToggle" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors border border-slate-200 text-xs font-bold">
                    <span class="text-lg">üåê</span>
                    <span id="langLabel">EN / ‰∏≠Êñá</span>
                </button>

                <span class="hidden md:inline text-xs text-slate-400">v6.0</span>
                <span id="systemStatus" class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                    System Ready
                </span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <!-- Intro -->
        <section class="mb-8 max-w-5xl mx-auto text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-800" data-i18n="intro_title">Fiber-to-Fiber Coupling & Alignment Physics</h2>
            <p class="text-slate-600 text-sm md:text-base max-w-3xl mx-auto leading-relaxed" data-i18n="intro_desc">
                Visualize the impact of 5-axis misalignment (X, Y, Z, Tilt X, Tilt Y) on coupling efficiency.
                Configure fiber parameters below to simulate different setups, demonstrating <strong class="text-blue-900">DiCon's expertise in high-precision free-space optics</strong>.
            </p>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: Controls & Parameters -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Result Display -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-100 ring-1 ring-slate-900/5">
                    <div class="bg-blue-900 px-6 py-4 flex justify-between items-center">
                        <h3 class="text-white font-semibold text-sm tracking-wide" data-i18n="metrics_title">REAL-TIME METRICS</h3>
                        <span id="lambdaDisplay" class="text-blue-200 text-xs font-mono">Œª = 1550 nm</span>
                    </div>
                    <div class="p-6 text-center">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1" data-i18n="lbl_eff">Coupling Efficiency</span>
                                <span id="effDisplay" class="text-3xl font-bold text-blue-700 font-mono">--%</span>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1" data-i18n="lbl_loss">Insertion Loss (IL)</span>
                                <span id="lossDisplay" class="text-3xl font-bold text-red-600 font-mono">-- dB</span>
                            </div>
                        </div>
                        <!-- Progress Bar -->
                        <div class="relative w-full bg-slate-200 rounded-full h-3 overflow-hidden shadow-inner">
                            <div id="efficiencyBar" class="absolute top-0 left-0 h-full bg-blue-600 transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                        <div id="feedbackText" class="mt-4 p-2 rounded bg-slate-50 text-xs text-slate-500 min-h-[3em] flex items-center justify-center font-medium">
                            Initializing...
                        </div>
                    </div>
                </div>

                <!-- Dual Fiber Configuration -->
                <div class="bg-slate-100 rounded-xl p-5 border border-slate-200 shadow-inner">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-blue-900 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            <span data-i18n="fiber_specs_title">Fiber Specifications</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <label class="text-[10px] font-bold text-slate-500" data-i18n="lbl_sys_lambda">System Œª:</label>
                            <input type="number" id="systemLambda" min="400" max="2500" value="1550" class="w-16 text-xs px-1 py-0.5 rounded border border-slate-300 text-center font-mono">
                            <span class="text-[10px] text-slate-400">nm</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Input Fiber Column -->
                        <div class="bg-white p-3 rounded-lg border border-red-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                            <h4 class="text-xs font-bold text-red-600 mb-2 pl-2" data-i18n="fiber_in_title">Input (Source)</h4>
                            
                            <label class="block text-[10px] text-slate-500 mb-1" data-i18n="lbl_preset">Preset</label>
                            <select id="fiberPresetIn" class="w-full text-xs bg-slate-50 border border-slate-200 rounded mb-2 px-1 py-1">
                                <option value="smf28">SMF-28 (10.4¬µm)</option>
                                <option value="hi1060">HI 1060 (6.2¬µm)</option>
                                <option value="custom" data-i18n="opt_custom">Custom</option>
                            </select>

                            <label class="block text-[10px] text-slate-500 mb-1">MFD (¬µm)</label>
                            <input type="number" id="mfdInputIn" step="0.1" class="w-full text-sm font-mono border border-slate-200 rounded px-2 py-1 text-slate-700">
                        </div>

                        <!-- Output Fiber Column -->
                        <div class="bg-white p-3 rounded-lg border border-blue-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-1 h-full bg-blue-500"></div>
                            <h4 class="text-xs font-bold text-blue-600 mb-2 text-right pr-2" data-i18n="fiber_out_title">Output (Receiver)</h4>
                            
                            <label class="block text-[10px] text-slate-500 mb-1 text-right" data-i18n="lbl_preset">Preset</label>
                            <select id="fiberPresetOut" class="w-full text-xs bg-slate-50 border border-slate-200 rounded mb-2 px-1 py-1 text-right" dir="rtl">
                                <option value="smf28">SMF-28 (10.4¬µm)</option>
                                <option value="hi1060">HI 1060 (6.2¬µm)</option>
                                <option value="custom" data-i18n="opt_custom">Custom</option>
                            </select>

                            <label class="block text-[10px] text-slate-500 mb-1 text-right">MFD (¬µm)</label>
                            <input type="number" id="mfdInputOut" step="0.1" class="w-full text-sm font-mono border border-slate-200 rounded px-2 py-1 text-slate-700 text-right">
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 text-center italic" data-i18n="mismatch_note">Mismatch in MFD causes intrinsic coupling loss.</p>
                </div>

                <!-- Alignment Controls -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2" data-i18n="align_title">
                            5-Axis Alignment
                        </h3>
                        <button id="resetBtn" class="text-xs text-blue-600 hover:text-white hover:bg-blue-600 font-medium px-3 py-1 bg-blue-50 rounded-full transition-all duration-200" data-i18n="btn_reset">
                            Reset Position
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Z Axis -->
                        <div class="relative group">
                            <div class="flex justify-between mb-2">
                                <label for="zInput" class="text-sm font-bold text-slate-700 flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-slate-400 mr-2 group-hover:bg-blue-500 transition-colors"></span>
                                    <span data-i18n="lbl_z">Z: Axial Gap</span>
                                </label>
                                <span id="zVal" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">0 Œºm</span>
                            </div>
                            <input type="range" id="zInput" min="0" max="300" step="1" value="0" 
                                class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-slate-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:bg-blue-600 hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                        </div>

                        <div class="grid grid-cols-2 gap-x-4 gap-y-6">
                            <!-- X Axis -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="xInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>
                                        <span data-i18n="lbl_x">Offset X</span>
                                    </label>
                                    <span id="xVal" class="text-[10px] font-mono bg-red-50 px-1.5 py-0.5 rounded text-red-600 border border-red-100">0.0</span>
                                </div>
                                <input type="range" id="xInput" min="-15" max="15" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-red-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Y Axis -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="yInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>
                                        <span data-i18n="lbl_y">Offset Y</span>
                                    </label>
                                    <span id="yVal" class="text-[10px] font-mono bg-red-50 px-1.5 py-0.5 rounded text-red-600 border border-red-100">0.0</span>
                                </div>
                                <input type="range" id="yInput" min="-15" max="15" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-red-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Tilt X -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="txInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-1.5"></span>
                                        <span data-i18n="lbl_tx">Tilt X</span>
                                    </label>
                                    <span id="txVal" class="text-[10px] font-mono bg-purple-50 px-1.5 py-0.5 rounded text-purple-600 border border-purple-100">0.0¬∞</span>
                                </div>
                                <input type="range" id="txInput" min="-3" max="3" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Tilt Y -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="tyInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-1.5"></span>
                                        <span data-i18n="lbl_ty">Tilt Y</span>
                                    </label>
                                    <span id="tyVal" class="text-[10px] font-mono bg-purple-50 px-1.5 py-0.5 rounded text-purple-600 border border-purple-100">0.0¬∞</span>
                                </div>
                                <input type="range" id="tyInput" min="-3" max="3" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Visualizations -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Visualization 1: Dual Beam Views (Top & Side) -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">1</span>
                            <span data-i18n="viz1_title">Fiber Alignment Visualization (Top & Side Views)</span>
                        </h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Top View -->
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-500 mb-2" data-i18n="viz_top_label">Top View (Beam Overlap)</span>
                            <div class="bg-slate-50 rounded-lg py-4 border border-slate-100 shadow-inner w-full flex justify-center">
                                <canvas id="beamCanvasTop" width="280" height="280" class="viz-canvas"></canvas>
                            </div>
                        </div>
                        <!-- Side View -->
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-bold text-slate-500 mb-2" data-i18n="viz_side_label">Side View (Z-Gap & Tilt)</span>
                            <div class="bg-slate-50 rounded-lg py-4 border border-slate-100 shadow-inner w-full flex justify-center items-center" style="height: 312px;">
                                <canvas id="beamCanvasSide" width="320" height="200" class="viz-canvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-center gap-6 text-xs text-slate-500">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500 ring-2 ring-red-200"></span>
                            <span data-i18n="legend_in">Input (Source)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500 ring-2 ring-blue-200"></span>
                            <span data-i18n="legend_out">Output (Receiver)</span>
                        </div>
                    </div>
                </div>

                <!-- Visualization 2: Sensitivity -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">2</span>
                            <span data-i18n="viz2_title">Alignment Sensitivity Profile (X-Axis)</span>
                        </h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-4" data-i18n="viz2_desc">Sensitivity curve showing the impact of lateral offset on coupling efficiency.</p>
                    <div class="chart-container">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                </div>

                <!-- Visualization 3: Heatmap -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">3</span>
                            <span data-i18n="viz3_title">2D Coupling Landscape (Heatmap)</span>
                        </h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-4" data-i18n="viz3_desc">Brighter regions indicate "Sweet Spot" for optimal coupling.</p>
                    <!-- Plotly uses its own container -->
                    <div id="contourPlot" class="w-full h-[350px] border border-slate-100 rounded-lg overflow-hidden shadow-inner"></div>
                </div>

            </div>
        </div>
    </main>

    <footer class="mt-12 py-10 bg-blue-950 text-slate-400 text-center border-t border-blue-900">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center mb-4">
                <span class="text-xl font-black text-white tracking-tighter mb-1">DiCon Fiberoptics</span>
                <p class="text-xs text-blue-300">Innovating Optical Solutions</p>
            </div>
            <p class="text-xs mb-2">¬© 2025 DiCon Fiberoptics, Inc. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        window.addEventListener('load', function() {
            console.log("DiCon Advanced System v6 Initializing...");
            
            // --- 0. Translations ---
            const i18n = {
                en: {
                    intro_title: "Fiber-to-Fiber Coupling & Alignment Physics",
                    intro_desc: "Visualize the impact of 5-axis misalignment (X, Y, Z, Tilt X, Tilt Y) on coupling efficiency. Configure fiber parameters below to simulate different setups, demonstrating DiCon's expertise in high-precision free-space optics.",
                    metrics_title: "REAL-TIME METRICS",
                    lbl_eff: "Coupling Efficiency",
                    lbl_loss: "Insertion Loss (IL)",
                    fiber_specs_title: "Fiber Specifications",
                    lbl_sys_lambda: "System Œª:",
                    fiber_in_title: "Input (Source)",
                    fiber_out_title: "Output (Receiver)",
                    lbl_preset: "Preset",
                    opt_custom: "Custom",
                    mismatch_note: "Mismatch in MFD causes intrinsic coupling loss.",
                    align_title: "5-Axis Alignment",
                    btn_reset: "Reset Position",
                    lbl_z: "Z: Axial Gap",
                    lbl_x: "Offset X",
                    lbl_y: "Offset Y",
                    lbl_tx: "Tilt X",
                    lbl_ty: "Tilt Y",
                    viz1_title: "Fiber Alignment Visualization (Top & Side Views)",
                    viz_top_label: "Top View (Beam Overlap)",
                    viz_side_label: "Side View (Z-Gap & Tilt)",
                    legend_in: "Input (Source)",
                    legend_out: "Output (Receiver)",
                    viz2_title: "Alignment Sensitivity Profile (X-Axis)",
                    viz2_desc: "Sensitivity curve showing the impact of lateral offset on coupling efficiency.",
                    viz3_title: "2D Coupling Landscape (Heatmap)",
                    viz3_desc: "Brighter regions indicate \"Sweet Spot\" for optimal coupling.",
                    // Dynamic values
                    status_excellent: "Excellent Alignment",
                    status_acceptable: "Acceptable",
                    status_weak: "Weak Signal",
                    status_loss: "High Loss / Misaligned",
                    chart_axis_x: "X Offset (Œºm)",
                    chart_axis_y: "Efficiency"
                },
                zh: {
                    intro_title: "ÂÖâÁ∫ñËÄ¶ÂêàÁâ©ÁêÜËàáÂ∞ç‰ΩçÊ®°Êì¨ (Fiber Coupling Physics)",
                    intro_desc: "Ë™øÊï¥ 5 Ëª∏ÂèÉÊï∏ (X, Y, Z, Tilt X, Tilt Y) ËßÄÂØüÂ∞çËÄ¶ÂêàÊïàÁéáÁöÑÂΩ±Èüø„ÄÇÈÄèÈÅé‰∏ãÊñπÂÖâÁ∫ñÂèÉÊï∏Ë®≠ÂÆöÊ®°Êì¨‰∏çÂêåÂ†¥ÊôØÔºåÂ±ïÁ§∫ DiCon Âú®È´òÁ≤æÂØÜËá™Áî±Á©∫ÈñìÂÖâÂ≠∏ÁöÑÊ†∏ÂøÉÊäÄË°ì„ÄÇ",
                    metrics_title: "Âç≥ÊôÇÊï∏ÊìöÁõ£Êéß",
                    lbl_eff: "ËÄ¶ÂêàÊïàÁéá (Efficiency)",
                    lbl_loss: "ÊèíÂÖ•ÊêçËÄó (Insertion Loss)",
                    fiber_specs_title: "ÂÖâÁ∫ñË¶èÊ†ºË®≠ÂÆö (Fiber Specs)",
                    lbl_sys_lambda: "Á≥ªÁµ±Ê≥¢Èï∑ Œª:",
                    fiber_in_title: "Ëº∏ÂÖ•Á´Ø (Source)",
                    fiber_out_title: "Ëº∏Âá∫Á´Ø (Receiver)",
                    lbl_preset: "È†êË®≠ÂûãËôü",
                    opt_custom: "Ëá™Ë®Ç (Custom)",
                    mismatch_note: "Ê≥®ÊÑèÔºöÊ®°ÊÖãÂ†¥Áõ¥Âæë (MFD) ‰∏çÂåπÈÖçÂ∞áÂ∞éËá¥Âõ∫ÊúâÁöÑËÄ¶ÂêàÊêçËÄó„ÄÇ",
                    align_title: "5 Ëª∏Â∞ç‰ΩçÊéßÂà∂ (Alignment)",
                    btn_reset: "ÈáçÁΩÆ‰ΩçÁΩÆ",
                    lbl_z: "Z Ëª∏: Ëª∏ÂêëÈñìË∑ù",
                    lbl_x: "X Ëª∏: Ê©´ÂêëÂÅèÁßª",
                    lbl_y: "Y Ëª∏: Ê©´ÂêëÂÅèÁßª",
                    lbl_tx: "Tx: X Ëª∏ÂÇæËßí",
                    lbl_ty: "Ty: Y Ëª∏ÂÇæËßí",
                    viz1_title: "ÂÖâÁ∫ñÂ∞ç‰ΩçË¶ñÂúñ (‰∏äË¶ñÂúñ & ÂÅ¥Ë¶ñÂúñ)",
                    viz_top_label: "‰∏äË¶ñÂúñ (ÂÖâÊñëÈáçÁñäÁãÄÊ≥Å)",
                    viz_side_label: "ÂÅ¥Ë¶ñÂúñ (Z Ëª∏ÈñìË∑ùËàáÂÇæËßí)",
                    legend_in: "Ëº∏ÂÖ•Á´Ø (Source)",
                    legend_out: "Ëº∏Âá∫Á´Ø (Receiver)",
                    viz2_title: "X Ëª∏ÂÅèÁßªÊïèÊÑüÂ∫¶Êõ≤Á∑ö (Sensitivity)",
                    viz2_desc: "È°ØÁ§∫Ê©´ÂêëÂÅèÁßªÂ∞çËÄ¶ÂêàÊïàÁéáÁöÑÂΩ±ÈüøÊõ≤Á∑ö (È´òÊñØÂàÜ‰Ωà)„ÄÇ",
                    viz3_title: "2D ËÄ¶ÂêàÊïàÁéáÁÜ±Âúñ (Heatmap)",
                    viz3_desc: "È°èËâ≤Ë∂ä‰∫Æ‰ª£Ë°®ËÄ¶ÂêàÊïàÁéáË∂äÈ´òÁöÑ„ÄåÁîúËúúÈªû (Sweet Spot)„Äç„ÄÇ",
                    // Dynamic values
                    status_excellent: "Â∞ç‰ΩçÂÑ™ËâØ (Excellent)",
                    status_acceptable: "Ë®äËôüÂ∞öÂèØ (Acceptable)",
                    status_weak: "Ë®äËôüÂæÆÂº± (Weak Signal)",
                    status_loss: "Âö¥ÈáçÊêçËÄó / Êú™Â∞çÊ∫ñ (Misaligned)",
                    chart_axis_x: "X Ëª∏ÂÅèÁßª (Œºm)",
                    chart_axis_y: "ËÄ¶ÂêàÊïàÁéá"
                }
            };

            let currentLang = 'en';

            function updateLanguage(lang) {
                currentLang = lang;
                
                // Update text content for static elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (i18n[lang][key]) {
                        el.textContent = i18n[lang][key];
                    }
                });

                // Trigger UI update to refresh dynamic text (status, charts)
                updateUI();
                // Update chart labels explicitly
                if(sensChart) {
                    sensChart.options.scales.x.title.text = i18n[lang].chart_axis_x;
                    sensChart.options.scales.y.title.text = i18n[lang].chart_axis_y;
                    sensChart.update();
                }
            }


            // --- 1. DOM Elements ---
            const els = {
                status: document.getElementById('systemStatus'),
                lambdaDisplay: document.getElementById('lambdaDisplay'),
                
                // Lang Toggle
                langToggle: document.getElementById('langToggle'),
                langLabel: document.getElementById('langLabel'),

                // New Config Inputs
                systemLambda: document.getElementById('systemLambda'),
                fiberPresetIn: document.getElementById('fiberPresetIn'),
                mfdInputIn: document.getElementById('mfdInputIn'),
                fiberPresetOut: document.getElementById('fiberPresetOut'),
                mfdInputOut: document.getElementById('mfdInputOut'),

                // Alignment Inputs
                inputs: {
                    x: document.getElementById('xInput'),
                    y: document.getElementById('yInput'),
                    z: document.getElementById('zInput'),
                    tx: document.getElementById('txInput'),
                    ty: document.getElementById('tyInput')
                },
                // Value Displays
                vals: {
                    x: document.getElementById('xVal'),
                    y: document.getElementById('yVal'),
                    z: document.getElementById('zVal'),
                    tx: document.getElementById('txVal'),
                    ty: document.getElementById('tyVal')
                },
                // Results
                results: {
                    eff: document.getElementById('effDisplay'),
                    loss: document.getElementById('lossDisplay'),
                    bar: document.getElementById('efficiencyBar'),
                    feedback: document.getElementById('feedbackText')
                },
                btn: { reset: document.getElementById('resetBtn') },
                canvasTop: document.getElementById('beamCanvasTop'),
                canvasSide: document.getElementById('beamCanvasSide')
            };

            // --- 2. State & Physics Constants ---
            const state = { x: 0, y: 0, z: 0, tx: 0, ty: 0 };
            
            // Fiber Presets
            const fiberData = {
                'smf28': { mfd: 10.4 },
                'hi1060': { mfd: 6.2 },
                'custom': { mfd: 10.4 } // default custom
            };

            // Current Physics Parameters (Dynamic)
            let physics = {
                lambdaMicrons: 1.550,
                w0_in: 5.2,  // Source waist (MFD/2)
                w0_out: 5.2, // Receiver waist (MFD/2)
                k: 0,
                zR_in: 0     // Rayleigh range of input beam
            };

            // Function to update physics constants
            function updatePhysicsParams() {
                // 1. Get System Wavelength
                let lambdaNm = parseFloat(els.systemLambda.value) || 1550;
                lambdaNm = Math.max(400, Math.min(2500, lambdaNm));
                physics.lambdaMicrons = lambdaNm / 1000;

                // 2. Get Input MFD
                let mfdInVal = parseFloat(els.mfdInputIn.value) || 10.4;
                physics.w0_in = mfdInVal / 2;

                // 3. Get Output MFD
                let mfdOutVal = parseFloat(els.mfdInputOut.value) || 10.4;
                physics.w0_out = mfdOutVal / 2;

                // 4. Derived Constants
                physics.k = (2 * Math.PI) / physics.lambdaMicrons; // n=1
                // Rayleigh range depends on Source beam size
                physics.zR_in = (Math.PI * physics.w0_in * physics.w0_in) / physics.lambdaMicrons;

                // Update UI Display
                els.lambdaDisplay.textContent = `Œª = ${lambdaNm} nm`;
                
                console.log("Physics Updated:", physics);
            }

            // --- 3. Physics Engine (General Gaussian Overlap) ---
            function calculateCoupling(dx, dy, dz, theta_x_deg, theta_y_deg) {
                const tx = theta_x_deg * (Math.PI / 180);
                const ty = theta_y_deg * (Math.PI / 180);

                // 1. Propagate Source Beam (Beam 1) to Receiver Plane
                const w1_z = physics.w0_in * Math.sqrt(1 + Math.pow(dz / physics.zR_in, 2));
                const R1_z = (dz === 0) ? Infinity : dz * (1 + Math.pow(physics.zR_in / dz, 2));

                // Receiver Beam (Beam 2) parameters at plane
                const w2 = physics.w0_out;

                // 2. Axial & Mode Mismatch Efficiency (Kogelnik's Formula generalized)
                const term_width = (w1_z / w2) + (w2 / w1_z);
                let term_curv = 0;
                if (R1_z !== Infinity) {
                    term_curv = (Math.PI * w1_z * w2) / (physics.lambdaMicrons * R1_z);
                }
                const eta_mode_axial = 4 / (term_width * term_width + term_curv * term_curv);

                // 3. Lateral Misalignment Factor
                const r_sq = (dx*dx) + (dy*dy);
                const w_eff_sq = (w1_z * w1_z) + (w2 * w2);
                const eta_lat = Math.exp((-2 * r_sq) / w_eff_sq);

                // 4. Angular Misalignment Factor
                const theta_sq = (tx*tx) + (ty*ty);
                const inv_w_sq_sum = (1 / (w1_z * w1_z)) + (1 / (w2 * w2));
                const coeff_ang = (2 * Math.PI * Math.PI) / (physics.lambdaMicrons * physics.lambdaMicrons);
                const eta_ang = Math.exp((-1 * coeff_ang * theta_sq) / inv_w_sq_sum);

                // Total Efficiency
                const efficiency = eta_mode_axial * eta_lat * eta_ang;

                return Math.max(0, Math.min(1, efficiency));
            }

            function getLoss(eff) {
                if (eff <= 0.0001) return "> 40.0";
                return (-10 * Math.log10(eff)).toFixed(2);
            }

            // --- 4. Visualization Managers ---
            
            // A. Canvas Beam Visualizer (TOP VIEW)
            const ctxTop = els.canvasTop.getContext('2d');
            
            function drawTopView() {
                const w = els.canvasTop.width;
                const h = els.canvasTop.height;
                const cx = w / 2;
                const cy = h / 2;
                
                const maxW = Math.max(physics.w0_in, physics.w0_out);
                const scale = 100 / (maxW * 4); 

                ctxTop.clearRect(0, 0, w, h);
                // Grid
                ctxTop.strokeStyle = 'rgba(255,255,255,0.05)';
                ctxTop.lineWidth = 1;
                ctxTop.beginPath(); ctxTop.moveTo(cx, 0); ctxTop.lineTo(cx, h); ctxTop.moveTo(0, cy); ctxTop.lineTo(w, cy); ctxTop.stroke();

                // 1. Fixed Fiber (Receiver) - Blue Ring
                ctxTop.beginPath();
                ctxTop.arc(cx, cy, physics.w0_out * scale, 0, Math.PI * 2);
                ctxTop.strokeStyle = '#3b82f6'; ctxTop.lineWidth = 2; ctxTop.stroke();
                ctxTop.fillStyle = 'rgba(59, 130, 246, 0.1)'; ctxTop.fill();

                // 2. Moving Fiber (Source) - Red Blob
                const mx = cx + (state.x * scale);
                const my = cy - (state.y * scale); 
                const wz = physics.w0_in * Math.sqrt(1 + Math.pow(state.z/physics.zR_in, 2));
                const visualRadius = wz * scale;
                const intensity = Math.max(0.2, 1 / (1 + state.z/(physics.zR_in*0.5))); 

                ctxTop.beginPath();
                ctxTop.arc(mx, my, visualRadius, 0, Math.PI * 2);
                ctxTop.fillStyle = `rgba(239, 68, 68, ${intensity * 0.5})`; ctxTop.fill();
                ctxTop.strokeStyle = `rgba(239, 68, 68, ${intensity})`; ctxTop.lineWidth = 2; ctxTop.stroke();

                // Crosshairs
                ctxTop.beginPath(); const ch = 4; ctxTop.moveTo(mx-ch, my); ctxTop.lineTo(mx+ch, my); ctxTop.moveTo(mx, my-ch); ctxTop.lineTo(mx, my+ch);
                ctxTop.strokeStyle = '#fff'; ctxTop.lineWidth = 1; ctxTop.stroke();
                
                // Tilt Arrow
                const tiltMag = Math.sqrt(state.tx*state.tx + state.ty*state.ty);
                if (tiltMag > 0.2) {
                    const endX = mx + (state.ty * 10);
                    const endY = my - (state.tx * 10);
                    drawArrow(ctxTop, mx, my, endX, endY, '#d8b4fe');
                }
            }

            function drawArrow(ctx, fromX, fromY, toX, toY, color) {
                const headlen = 8; const dx = toX - fromX; const dy = toY - fromY; const angle = Math.atan2(dy, dx);
                ctx.beginPath(); ctx.moveTo(fromX, fromY); ctx.lineTo(toX, toY); ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.setLineDash([2, 2]); ctx.stroke(); ctx.setLineDash([]);
                ctx.beginPath(); ctx.moveTo(toX, toY); ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6)); ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6)); ctx.fillStyle = color; ctx.fill();
            }

            // B. Canvas Side View (UPDATED LOGIC: In/Red/Left -> Out/Blue/Right)
            const ctxSide = els.canvasSide.getContext('2d');

            function drawSideView() {
                const w = els.canvasSide.width;
                const h = els.canvasSide.height;
                const centerY = h / 2;
                const scaleX = (w * 0.6) / 300; 
                const scaleY = scaleX * 4; 

                ctxSide.clearRect(0, 0, w, h);
                // Optical Axis
                ctxSide.strokeStyle = 'rgba(255,255,255,0.1)'; ctxSide.setLineDash([5, 5]);
                ctxSide.beginPath(); ctxSide.moveTo(0, centerY); ctxSide.lineTo(w, centerY); ctxSide.stroke(); ctxSide.setLineDash([]);

                const fiberWidth = 40; const fiberHeight = 80; 
                
                // Fixed Anchor for Input (Source/Red) is Left
                const inputFiberXEnd = w * 0.2; 
                
                // 1. Draw Input Fiber (Source/Red) - Fixed on Left
                ctxSide.fillStyle = '#991b1b'; // Dark Red body
                ctxSide.fillRect(inputFiberXEnd - fiberWidth, centerY - fiberHeight/2, fiberWidth, fiberHeight);
                ctxSide.fillStyle = '#ef4444'; // Red Core
                ctxSide.fillRect(inputFiberXEnd - fiberWidth, centerY - (physics.w0_in*scaleY), fiberWidth, physics.w0_in*2*scaleY);
                ctxSide.beginPath(); ctxSide.moveTo(inputFiberXEnd, centerY - fiberHeight/2); ctxSide.lineTo(inputFiberXEnd, centerY + fiberHeight/2); ctxSide.strokeStyle = '#fca5a5'; ctxSide.lineWidth=2; ctxSide.stroke();

                // 2. Draw Output Fiber (Receiver/Blue) - Moving on Right
                const zGapPx = state.z * scaleX;
                const lateralOffsetPx = Math.sqrt(state.x*state.x + state.y*state.y) * scaleY;
                
                const outputFiberXStart = inputFiberXEnd + zGapPx;
                const outputFiberYCenter = centerY - lateralOffsetPx; 

                ctxSide.save();
                ctxSide.translate(outputFiberXStart, outputFiberYCenter);
                // Rotate Output Fiber (Tilt)
                const tiltRad = -Math.sqrt(state.tx*state.tx + state.ty*state.ty) * (Math.PI/180);
                ctxSide.rotate(tiltRad * 5); 

                ctxSide.fillStyle = '#1e3a8a'; // Dark Blue body
                ctxSide.fillRect(0, -fiberHeight/2, fiberWidth, fiberHeight);
                ctxSide.fillStyle = '#3b82f6'; // Blue Core
                ctxSide.fillRect(0, -(physics.w0_out*scaleY), fiberWidth, physics.w0_out*2*scaleY);
                ctxSide.beginPath(); ctxSide.moveTo(0, -fiberHeight/2); ctxSide.lineTo(0, fiberHeight/2); ctxSide.strokeStyle = '#60a5fa'; ctxSide.lineWidth=2; ctxSide.stroke();
                ctxSide.restore(); 

                // 3. Beam Cone (Source Red -> Receiver Blue)
                // Starts at Input (Left), expands to Output (Right)
                
                const beamStartX = inputFiberXEnd;
                const beamEndX = outputFiberXStart;
                
                // Width at Start = w0_in
                const beamRadStart = physics.w0_in * scaleY;
                
                // Width at End = w(z)
                const wzAtReceiver = physics.w0_in * Math.sqrt(1 + Math.pow(state.z/physics.zR_in, 2));
                const beamRadEnd = wzAtReceiver * scaleY;

                ctxSide.beginPath();
                ctxSide.moveTo(beamStartX, centerY - beamRadStart);
                ctxSide.lineTo(beamEndX, outputFiberYCenter - beamRadEnd);
                ctxSide.lineTo(beamEndX, outputFiberYCenter + beamRadEnd);
                ctxSide.lineTo(beamStartX, centerY + beamRadStart);
                ctxSide.closePath();
                
                const grd = ctxSide.createLinearGradient(beamStartX, centerY, beamEndX, centerY);
                grd.addColorStop(0, 'rgba(239, 68, 68, 0.4)');
                grd.addColorStop(1, 'rgba(59, 130, 246, 0.1)');
                ctxSide.fillStyle = grd;
                ctxSide.fill();
            }

            // C. Charts
            let sensChart = null;
            function initSensChart() {
                const ctxS = document.getElementById('sensitivityChart');
                if(!ctxS) return;
                sensChart = new Chart(ctxS, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Profile', data: [], borderColor: '#1e3a8a', borderWidth: 2, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(30, 58, 138, 0.05)' }, { label: 'Current', data: [], borderColor: '#ef4444', backgroundColor: '#ef4444', pointRadius: 6, showLine: false }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, 
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            x: { type: 'linear', min: -15, max: 15, title: {display: true, text: 'X Offset (Œºm)'} }, 
                            y: { min: 0, max: 1.1, title: {display: true, text: 'Efficiency'} } 
                        } 
                    }
                });
            }

            function updateSensChart() {
                if(!sensChart) return;
                const dataPoints = [];
                for(let i = -15; i <= 15; i+=0.5) {
                    const eff = calculateCoupling(i, state.y, state.z, state.tx, state.ty);
                    dataPoints.push({x: i, y: eff});
                }
                const currEff = calculateCoupling(state.x, state.y, state.z, state.tx, state.ty);
                sensChart.data.datasets[0].data = dataPoints;
                sensChart.data.datasets[1].data = [{x: state.x, y: currEff}];
                sensChart.update('none');
            }

            let plotlyLoaded = false;
            function initPlotly() {
                 const container = document.getElementById('contourPlot');
                if(!container || typeof Plotly === 'undefined') return;
                const data = [{ z: [[0]], type: 'contour', colorscale: 'Viridis' }];
                const layout = { margin: { l: 40, r: 20, b: 40, t: 20 }, xaxis: { title: 'X', range: [-15, 15] }, yaxis: { title: 'Y', range: [-15, 15] }, autosize: true };
                Plotly.newPlot('contourPlot', data, layout, {displayModeBar: false, responsive: true}).then(() => { plotlyLoaded = true; updatePlotly(); });
            }

            function updatePlotly() {
                if(!plotlyLoaded) return;
                const size = 25; const limit = 15; const step = (limit*2) / (size-1);
                const xArr = []; const yArr = []; const zArr = [];
                for(let i=0; i<size; i++) {
                    const y = -limit + (i*step); yArr.push(y); const row = [];
                    for(let j=0; j<size; j++) {
                        const x = -limit + (j*step); if(i===0) xArr.push(x);
                        row.push(calculateCoupling(x, y, state.z, state.tx, state.ty));
                    }
                    zArr.push(row);
                }
                const contourTrace = { type: 'contour', z: zArr, x: xArr, y: yArr, colorscale: [ [0, '#0f172a'], [0.2, '#1e3a8a'], [0.5, '#3b82f6'], [0.8, '#60a5fa'], [1, '#ffffff'] ], contours: { coloring: 'heatmap', showlabels: false }, showscale: false };
                const markerTrace = { type: 'scatter', mode: 'markers', x: [state.x], y: [state.y], marker: { color: 'red', size: 10, symbol: 'cross', line: {color:'white', width:1} } };
                const layout = { margin: { l: 40, r: 20, b: 40, t: 20 }, xaxis: { range: [-15, 15] }, yaxis: { range: [-15, 15] }, autosize: true, showlegend: false };
                Plotly.react('contourPlot', [contourTrace, markerTrace], layout);
            }


            // --- 5. Master Update ---
            function updateUI() {
                // Displays
                els.vals.x.textContent = state.x.toFixed(1) + " Œºm";
                els.vals.y.textContent = state.y.toFixed(1) + " Œºm";
                els.vals.z.textContent = state.z.toFixed(0) + " Œºm";
                els.vals.tx.textContent = state.tx.toFixed(1) + "¬∞";
                els.vals.ty.textContent = state.ty.toFixed(1) + "¬∞";

                const eff = calculateCoupling(state.x, state.y, state.z, state.tx, state.ty);
                const db = getLoss(eff);
                const pct = (eff * 100).toFixed(1);

                els.results.eff.textContent = pct + "%";
                els.results.loss.textContent = db + " dB";
                els.results.bar.style.width = pct + "%";

                let barColor = "bg-red-500"; let statusKey = "status_loss"; let statusClass = "text-red-600";
                
                if(eff > 0.9) { barColor = "bg-green-500"; statusKey = "status_excellent"; statusClass = "text-green-600 font-bold"; } 
                else if(eff > 0.5) { barColor = "bg-blue-500"; statusKey = "status_acceptable"; statusClass = "text-blue-600 font-medium"; } 
                else if(eff > 0.1) { barColor = "bg-yellow-500"; statusKey = "status_weak"; statusClass = "text-yellow-600"; } 
                
                // Use i18n for dynamic status
                const statusText = i18n[currentLang][statusKey];

                els.results.bar.className = `absolute top-0 left-0 h-full transition-all duration-300 ease-out ${barColor}`;
                els.results.feedback.textContent = statusText;
                els.results.feedback.className = `mt-4 p-2 rounded bg-slate-50 text-xs text-center border border-slate-100 ${statusClass}`;

                drawTopView();
                drawSideView();
                updateSensChart();
                updatePlotly();
            }

            // --- 6. Event Listeners ---
            function bindEvents() {
                // Lang Toggle
                els.langToggle.addEventListener('click', () => {
                    const newLang = currentLang === 'en' ? 'zh' : 'en';
                    updateLanguage(newLang);
                });

                // Alignment
                ['x', 'y', 'z', 'tx', 'ty'].forEach(key => {
                    els.inputs[key].addEventListener('input', (e) => { state[key] = parseFloat(e.target.value); updateUI(); });
                });
                els.btn.reset.addEventListener('click', () => {
                    state.x = 0; state.y = 0; state.z = 0; state.tx = 0; state.ty = 0;
                    Object.keys(els.inputs).forEach(k => els.inputs[k].value = 0);
                    updateUI();
                });

                // Config Handlers
                function handlePresetChange(isInput, value) {
                    const data = fiberData[value] || fiberData['custom'];
                    const inputEl = isInput ? els.mfdInputIn : els.mfdInputOut;
                    inputEl.value = data.mfd;
                    if(value === 'custom') inputEl.focus();
                    updatePhysicsParams(); updateUI();
                }

                els.fiberPresetIn.addEventListener('change', (e) => handlePresetChange(true, e.target.value));
                els.fiberPresetOut.addEventListener('change', (e) => handlePresetChange(false, e.target.value));
                els.mfdInputIn.addEventListener('change', () => { els.fiberPresetIn.value='custom'; updatePhysicsParams(); updateUI(); });
                els.mfdInputOut.addEventListener('change', () => { els.fiberPresetOut.value='custom'; updatePhysicsParams(); updateUI(); });
                els.systemLambda.addEventListener('change', () => { updatePhysicsParams(); updateUI(); });

                window.addEventListener('resize', () => {
                    if(sensChart) sensChart.resize();
                    if(plotlyLoaded) Plotly.Plots.resize('contourPlot');
                    drawTopView(); drawSideView();
                });
            }

            // --- 7. Ignite ---
            // Set defaults
            els.fiberPresetIn.value = 'smf28'; els.mfdInputIn.value = fiberData.smf28.mfd;
            els.fiberPresetOut.value = 'smf28'; els.mfdInputOut.value = fiberData.smf28.mfd;
            
            updatePhysicsParams();
            initSensChart();
            initPlotly();
            bindEvents();
            updateUI();
            
            els.status.textContent = "System Ready";
        });
    </script>
</body>
</html>