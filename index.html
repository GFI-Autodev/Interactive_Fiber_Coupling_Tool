<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Coupling Simulator | DiCon Fiberoptics</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Chart Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        #beamCanvas {
            border-radius: 50%;
            background: #0f172a; /* Slate 900 */
            box-shadow: inset 0 0 20px #000;
            display: block;
            margin: 0 auto;
        }
        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-blue-200 selection:text-blue-900 font-sans">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-20">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <!-- DiCon Branding Area -->
            <div class="flex items-center gap-3">
                <!-- Icon Placeholder (You can replace src with actual logo url if needed) -->
                <div class="w-10 h-10 bg-blue-900 rounded-lg flex items-center justify-center text-white font-serif font-bold text-xl shadow-sm">
                    D
                </div>
                <div class="flex flex-col">
                    <div class="leading-none">
                        <span class="text-2xl font-black text-blue-900 tracking-tighter">DiCon</span>
                        <span class="text-2xl font-light text-slate-600 tracking-tight">Fiberoptics</span>
                    </div>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wide uppercase mt-1">Directing Light with MEMS Technology</p>
                </div>
            </div>
            
            <div class="mt-4 md:mt-0 text-right flex items-center gap-3">
                <span class="hidden md:inline text-xs text-slate-400">Interactive Simulation Tool v2.1</span>
                <span id="systemStatus" class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                    System Ready
                </span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <!-- Intro -->
        <section class="mb-8 max-w-5xl mx-auto text-center">
            <h2 class="text-3xl font-bold mb-3 text-slate-800">Fiber Coupling Efficiency & Alignment</h2>
            <p class="text-slate-600 text-sm md:text-base max-w-3xl mx-auto leading-relaxed">
                Explore the physics behind <strong class="text-blue-900">DiCon's high-precision alignment</strong>. 
                Adjust the 5-axis parameters (X, Y, Z, Tilt X, Tilt Y) to simulate the coupling between two SMF-28 fibers 
                and visualize the impact of <span class="italic">Lateral Offset</span>, <span class="italic">Axial Gap</span>, and <span class="italic">Angular Misalignment</span> on Insertion Loss.
            </p>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: Controls -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Result Display -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-100 ring-1 ring-slate-900/5">
                    <div class="bg-blue-900 px-6 py-4 flex justify-between items-center">
                        <h3 class="text-white font-semibold text-sm tracking-wide">REAL-TIME METRICS</h3>
                        <span class="text-blue-200 text-xs font-mono">λ = 1550 nm</span>
                    </div>
                    <div class="p-6 text-center">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Coupling Efficiency</span>
                                <span id="effDisplay" class="text-3xl font-bold text-blue-700 font-mono">--%</span>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Insertion Loss (IL)</span>
                                <span id="lossDisplay" class="text-3xl font-bold text-red-600 font-mono">-- dB</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="relative w-full bg-slate-200 rounded-full h-3 overflow-hidden shadow-inner">
                            <div id="efficiencyBar" class="absolute top-0 left-0 h-full bg-blue-600 transition-all duration-300 ease-out" style="width: 0%"></div>
                        </div>
                        
                        <div id="feedbackText" class="mt-4 p-2 rounded bg-slate-50 text-xs text-slate-500 min-h-[3em] flex items-center justify-center font-medium">
                            Initializing physics engine...
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            Alignment Controls
                        </h3>
                        <button id="resetBtn" class="text-xs text-blue-600 hover:text-white hover:bg-blue-600 font-medium px-3 py-1 bg-blue-50 rounded-full transition-all duration-200">
                            Reset All
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Z Axis -->
                        <div class="relative group">
                            <div class="flex justify-between mb-2">
                                <label for="zInput" class="text-sm font-bold text-slate-700 flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-slate-400 mr-2 group-hover:bg-blue-500 transition-colors"></span>Z: Axial Gap
                                </label>
                                <span id="zVal" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">0 μm</span>
                            </div>
                            <input type="range" id="zInput" min="0" max="200" step="1" value="0" 
                                class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-slate-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:bg-blue-600 hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                        </div>

                        <div class="grid grid-cols-2 gap-x-4 gap-y-6">
                            <!-- X Axis -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="xInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>Offset X
                                    </label>
                                    <span id="xVal" class="text-[10px] font-mono bg-red-50 px-1.5 py-0.5 rounded text-red-600 border border-red-100">0.0</span>
                                </div>
                                <input type="range" id="xInput" min="-15" max="15" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-red-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Y Axis -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="yInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-red-500 mr-1.5"></span>Offset Y
                                    </label>
                                    <span id="yVal" class="text-[10px] font-mono bg-red-50 px-1.5 py-0.5 rounded text-red-600 border border-red-100">0.0</span>
                                </div>
                                <input type="range" id="yInput" min="-15" max="15" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-red-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Tilt X -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="txInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-1.5"></span>Tilt X
                                    </label>
                                    <span id="txVal" class="text-[10px] font-mono bg-purple-50 px-1.5 py-0.5 rounded text-purple-600 border border-purple-100">0.0°</span>
                                </div>
                                <input type="range" id="txInput" min="-3" max="3" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>

                            <!-- Tilt Y -->
                            <div class="relative group">
                                <div class="flex justify-between mb-2">
                                    <label for="tyInput" class="text-sm font-bold text-slate-700 flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-1.5"></span>Tilt Y
                                    </label>
                                    <span id="tyVal" class="text-[10px] font-mono bg-purple-50 px-1.5 py-0.5 rounded text-purple-600 border border-purple-100">0.0°</span>
                                </div>
                                <input type="range" id="tyInput" min="-3" max="3" step="0.1" value="0" 
                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:bg-purple-500 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:shadow-md hover:[&::-webkit-slider-thumb]:scale-110 transition-all">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parameters Info -->
                <div class="bg-slate-100 rounded-xl p-4 border border-slate-200 text-xs text-slate-600">
                    <p class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"></path></svg>
                        Simulation Parameters (SMF-28):
                    </p>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white px-2 py-1 rounded border border-slate-200">Wavelength: 1550 nm</div>
                        <div class="bg-white px-2 py-1 rounded border border-slate-200">MFD: 10.4 μm</div>
                        <div class="bg-white px-2 py-1 rounded border border-slate-200">Medium: Air (n=1)</div>
                        <div class="bg-white px-2 py-1 rounded border border-slate-200">Model: Gaussian</div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Visualizations -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Visualization 1: Beam Overlap -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">1</span>
                            Beam Overlap Visualization
                        </h3>
                        <span class="text-[10px] font-mono text-slate-400 border border-slate-200 px-2 py-1 rounded bg-slate-50">Scale: ~5μm/div</span>
                    </div>
                    
                    <!-- Canvas Container -->
                    <div class="flex justify-center bg-slate-50 rounded-lg py-4 border border-slate-100 shadow-inner">
                        <canvas id="beamCanvas" width="320" height="320"></canvas>
                    </div>

                    <div class="mt-4 flex justify-center gap-6 text-xs text-slate-500">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500 ring-2 ring-blue-200"></span> Fixed Fiber (Target)
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500 ring-2 ring-red-200"></span> Moving Fiber (Source)
                        </div>
                    </div>
                </div>

                <!-- Visualization 2: Sensitivity -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">2</span>
                            Alignment Sensitivity Profile (X-Axis)
                        </h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Efficiency drop-off curve for lateral misalignment at current Z/Tilt.</p>
                    <div class="chart-container">
                        <canvas id="sensitivityChart"></canvas>
                    </div>
                </div>

                <!-- Visualization 3: Heatmap -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-6 h-6 rounded bg-blue-100 text-blue-700 text-xs font-bold">3</span>
                            2D Coupling Landscape (Heatmap)
                        </h3>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Brighter regions indicate "Sweet Spot" for optimal coupling.</p>
                    <!-- Plotly uses its own container -->
                    <div id="contourPlot" class="w-full h-[350px] border border-slate-100 rounded-lg overflow-hidden shadow-inner"></div>
                </div>

            </div>
        </div>
    </main>

    <footer class="mt-12 py-10 bg-blue-950 text-slate-400 text-center border-t border-blue-900">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center mb-4">
                <span class="text-xl font-black text-white tracking-tighter mb-1">DiCon Fiberoptics</span>
                <p class="text-xs text-blue-300">Innovating Optical Solutions</p>
            </div>
            <p class="text-xs mb-2">© 2025 DiCon Fiberoptics, Inc. All rights reserved.</p>
            <p class="text-[10px] text-slate-500">
                1689 Regatta Blvd. Richmond, CA 94804 | Phone: (510) 620-5000
            </p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // Use an IIFE or window.onload to ensure DOM is ready before accessing elements
        window.addEventListener('load', function() {
            console.log("DiCon System Initializing...");
            
            // --- 1. DOM Elements (Safe to access now) ---
            const els = {
                status: document.getElementById('systemStatus'),
                inputs: {
                    x: document.getElementById('xInput'),
                    y: document.getElementById('yInput'),
                    z: document.getElementById('zInput'),
                    tx: document.getElementById('txInput'),
                    ty: document.getElementById('tyInput')
                },
                vals: {
                    x: document.getElementById('xVal'),
                    y: document.getElementById('yVal'),
                    z: document.getElementById('zVal'),
                    tx: document.getElementById('txVal'),
                    ty: document.getElementById('tyVal')
                },
                results: {
                    eff: document.getElementById('effDisplay'),
                    loss: document.getElementById('lossDisplay'),
                    bar: document.getElementById('efficiencyBar'),
                    feedback: document.getElementById('feedbackText')
                },
                btn: {
                    reset: document.getElementById('resetBtn')
                },
                canvas: document.getElementById('beamCanvas')
            };

            // --- 2. State & Physics Constants ---
            const state = { x: 0, y: 0, z: 0, tx: 0, ty: 0 };
            
            // SMF-28 specs @ 1550nm
            const LAMBDA = 1.55; // micron
            const W0 = 5.2; // Mode field radius (MFD/2)
            const n = 1.0; // Refractive index of gap (air)
            const k = (2 * Math.PI * n) / LAMBDA;
            // Rayleigh range
            const zR = (Math.PI * W0 * W0) / LAMBDA;

            // --- 3. Physics Engine (Robust) ---
            function calculateCoupling(dx, dy, dz, theta_x_deg, theta_y_deg) {
                // Convert deg to rad
                const tx = theta_x_deg * (Math.PI / 180);
                const ty = theta_y_deg * (Math.PI / 180);

                // 1. Beam Expansion (Longitudinal Mismatch)
                const D = dz / zR;
                const eta_z = 4 / (4 + (D * D));

                // 2. Lateral & Angular Misalignment
                const r_sq = (dx*dx) + (dy*dy);
                const theta_sq = (tx*tx) + (ty*ty);
                
                // Normalization factors
                const lat_term = r_sq / (W0 * W0);
                const ang_coeff = Math.pow((Math.PI * n * W0) / LAMBDA, 2);
                const ang_term = ang_coeff * theta_sq;

                // Combine
                const exponent = -eta_z * (lat_term + ang_term);
                const efficiency = eta_z * Math.exp(exponent);

                return Math.max(0, Math.min(1, efficiency));
            }

            function getLoss(eff) {
                if (eff <= 0.0001) return "> 40.0";
                return (-10 * Math.log10(eff)).toFixed(2);
            }

            // --- 4. Visualization Managers ---
            
            // A. Canvas Beam Visualizer
            const ctx = els.canvas.getContext('2d');
            
            function drawBeam() {
                const w = els.canvas.width;
                const h = els.canvas.height;
                const cx = w / 2;
                const cy = h / 2;
                const scale = 8; 

                ctx.clearRect(0, 0, w, h);

                // Grid lines
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(cx, 0); ctx.lineTo(cx, h);
                ctx.moveTo(0, cy); ctx.lineTo(w, cy);
                ctx.stroke();

                // 1. Fixed Fiber (Target) - Blue Ring
                ctx.beginPath();
                ctx.arc(cx, cy, W0 * scale, 0, Math.PI * 2);
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                ctx.fill();

                // 2. Moving Fiber (Source) - Red Blob
                const mx = cx + (state.x * scale);
                const my = cy - (state.y * scale); 

                // Beam Expansion Visual
                const wz = W0 * Math.sqrt(1 + Math.pow(state.z/zR, 2));
                const visualRadius = wz * scale;

                // Opacity fades with Z
                const intensity = Math.max(0.2, 1 / (1 + state.z/50)); 

                ctx.beginPath();
                ctx.arc(mx, my, visualRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(239, 68, 68, ${intensity * 0.5})`;
                ctx.fill();
                ctx.strokeStyle = `rgba(239, 68, 68, ${intensity})`;
                ctx.lineWidth = 2;
                ctx.stroke();

                // 3. Center Crosshairs
                ctx.beginPath();
                const ch = 4;
                ctx.moveTo(mx - ch, my); ctx.lineTo(mx + ch, my);
                ctx.moveTo(mx, my - ch); ctx.lineTo(mx, my + ch);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();

                // 4. Tilt Indicator (Arrow)
                const tiltMag = Math.sqrt(state.tx*state.tx + state.ty*state.ty);
                if (tiltMag > 0.2) {
                    const arrowLen = 25;
                    const endX = mx + (state.ty * 10);
                    const endY = my - (state.tx * 10);
                    
                    ctx.beginPath();
                    ctx.moveTo(mx, my);
                    ctx.lineTo(endX, endY);
                    ctx.strokeStyle = '#d8b4fe'; // Purple
                    ctx.lineWidth = 2;
                    ctx.setLineDash([2, 2]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    ctx.beginPath();
                    ctx.arc(endX, endY, 2, 0, Math.PI*2);
                    ctx.fillStyle = '#d8b4fe';
                    ctx.fill();
                }
            }

            // B. Chart.js Sensitivity
            let sensChart = null;
            function initSensChart() {
                const ctxS = document.getElementById('sensitivityChart');
                if(!ctxS) return;
                
                sensChart = new Chart(ctxS, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Efficiency Profile',
                                data: [],
                                borderColor: '#1e3a8a', // Blue 900
                                borderWidth: 2,
                                tension: 0.4,
                                pointRadius: 0,
                                fill: true,
                                backgroundColor: 'rgba(30, 58, 138, 0.05)'
                            },
                            {
                                label: 'Current Position',
                                data: [],
                                borderColor: '#ef4444',
                                backgroundColor: '#ef4444',
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                showLine: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                callbacks: {
                                    label: function(context) {
                                        return 'Eff: ' + (context.parsed.y * 100).toFixed(1) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'X Offset (μm)', color: '#64748b' },
                                min: -15, max: 15,
                                grid: { color: '#f1f5f9' },
                                ticks: { color: '#64748b' }
                            },
                            y: {
                                min: 0, max: 1.1,
                                title: { display: true, text: 'Efficiency', color: '#64748b' },
                                ticks: { format: { style: 'percent' }, color: '#64748b' },
                                grid: { color: '#f1f5f9' }
                            }
                        }
                    }
                });
            }

            function updateSensChart() {
                if(!sensChart) return;
                
                const dataPoints = [];
                for(let i = -15; i <= 15; i+=0.5) {
                    const eff = calculateCoupling(i, state.y, state.z, state.tx, state.ty);
                    dataPoints.push({x: i, y: eff});
                }
                
                const currEff = calculateCoupling(state.x, state.y, state.z, state.tx, state.ty);

                sensChart.data.datasets[0].data = dataPoints;
                sensChart.data.datasets[1].data = [{x: state.x, y: currEff}];
                sensChart.update('none');
            }

            // C. Plotly Heatmap
            let plotlyLoaded = false;
            
            function initPlotly() {
                const container = document.getElementById('contourPlot');
                if(!container || typeof Plotly === 'undefined') {
                    return;
                }

                const data = [{
                    z: [[0]],
                    type: 'contour',
                    colorscale: 'Viridis'
                }];
                
                const layout = {
                    margin: { l: 40, r: 20, b: 40, t: 20 },
                    xaxis: { title: 'X (μm)', range: [-15, 15] },
                    yaxis: { title: 'Y (μm)', range: [-15, 15] },
                    autosize: true
                };
                
                Plotly.newPlot('contourPlot', data, layout, {displayModeBar: false, responsive: true})
                .then(() => { plotlyLoaded = true; updatePlotly(); });
            }

            function updatePlotly() {
                if(!plotlyLoaded) return;
                
                const size = 25;
                const limit = 15;
                const step = (limit*2) / (size-1);
                
                const xArr = [];
                const yArr = [];
                const zArr = [];

                for(let i=0; i<size; i++) {
                    const y = -limit + (i*step);
                    yArr.push(y);
                    const row = [];
                    for(let j=0; j<size; j++) {
                        const x = -limit + (j*step);
                        if(i===0) xArr.push(x);
                        row.push(calculateCoupling(x, y, state.z, state.tx, state.ty));
                    }
                    zArr.push(row);
                }

                const contourTrace = {
                    type: 'contour',
                    z: zArr,
                    x: xArr,
                    y: yArr,
                    // DiCon Corporate Colors styled heatmap
                    colorscale: [
                        [0, '#0f172a'],   // Dark Slate
                        [0.2, '#1e3a8a'], // Dark Blue
                        [0.5, '#3b82f6'], // Blue
                        [0.8, '#60a5fa'], // Light Blue
                        [1, '#ffffff']    // White peak
                    ],
                    contours: { coloring: 'heatmap', showlabels: false },
                    showscale: false
                };
                
                const markerTrace = {
                    type: 'scatter',
                    mode: 'markers',
                    x: [state.x],
                    y: [state.y],
                    marker: { color: 'red', size: 10, symbol: 'cross', line: {color:'white', width:1} }
                };

                const layout = {
                    margin: { l: 40, r: 20, b: 40, t: 20 },
                    xaxis: { title: 'X (μm)', range: [-15, 15] },
                    yaxis: { title: 'Y (μm)', range: [-15, 15] },
                    autosize: true,
                    showlegend: false
                };

                Plotly.react('contourPlot', [contourTrace, markerTrace], layout);
            }


            // --- 5. Master Update ---
            function updateUI() {
                // Update Numeric Displays
                els.vals.x.textContent = state.x.toFixed(1) + " μm";
                els.vals.y.textContent = state.y.toFixed(1) + " μm";
                els.vals.z.textContent = state.z.toFixed(0) + " μm";
                els.vals.tx.textContent = state.tx.toFixed(1) + "°";
                els.vals.ty.textContent = state.ty.toFixed(1) + "°";

                const eff = calculateCoupling(state.x, state.y, state.z, state.tx, state.ty);
                const db = getLoss(eff);
                const pct = (eff * 100).toFixed(1);

                els.results.eff.textContent = pct + "%";
                els.results.loss.textContent = db + " dB";
                els.results.bar.style.width = pct + "%";

                let barColor = "bg-red-500";
                let statusText = "";
                let statusClass = "text-red-600";
                
                if(eff > 0.9) {
                    barColor = "bg-green-500";
                    statusText = "Excellent Alignment";
                    statusClass = "text-green-600 font-bold";
                } else if(eff > 0.5) {
                    barColor = "bg-blue-500";
                    statusText = "Acceptable Signal";
                    statusClass = "text-blue-600 font-medium";
                } else if(eff > 0.1) {
                    barColor = "bg-yellow-500";
                    statusText = "Weak Signal";
                    statusClass = "text-yellow-600";
                } else {
                    statusText = "High Loss / Misaligned";
                }

                els.results.bar.className = `absolute top-0 left-0 h-full transition-all duration-300 ease-out ${barColor}`;
                els.results.feedback.textContent = statusText;
                els.results.feedback.className = `mt-4 p-2 rounded bg-slate-50 text-xs text-center border border-slate-100 ${statusClass}`;

                drawBeam();
                updateSensChart();
                updatePlotly();
            }

            // --- 6. Event Listeners ---
            function bindEvents() {
                ['x', 'y', 'z', 'tx', 'ty'].forEach(key => {
                    els.inputs[key].addEventListener('input', (e) => {
                        state[key] = parseFloat(e.target.value);
                        updateUI();
                    });
                });

                els.btn.reset.addEventListener('click', () => {
                    state.x = 0; state.y = 0; state.z = 0; state.tx = 0; state.ty = 0;
                    Object.keys(els.inputs).forEach(k => els.inputs[k].value = 0);
                    updateUI();
                });

                window.addEventListener('resize', () => {
                    if(sensChart) sensChart.resize();
                    if(plotlyLoaded) Plotly.Plots.resize('contourPlot');
                });
            }

            // --- 7. Ignite ---
            initSensChart();
            initPlotly();
            bindEvents();
            updateUI();
            
            els.status.textContent = "System Ready";
        });
    </script>
</body>
</html>